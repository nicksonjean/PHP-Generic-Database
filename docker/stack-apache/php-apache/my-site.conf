<VirtualHost *:80>
    ServerAdmin webmaster@localhost
    ServerName localhost
    DocumentRoot /var/www/html

    # Incluir arquivo de variáveis de ambiente gerado dinamicamente
    Include /etc/apache2/conf-enabled/env-vars.conf

    <Directory /var/www/html/>
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
        DirectoryIndex index.php index.html index.htm
        IndexIgnore composer.json composer.lock doctum.php grumphp.yml phpcs.xml phpmd.xml phpstan.neon phpunit.xml *.stub.php *.md *.sh *.bat *.mmd docker-compose.yml *.lock.json favicon.ico apache-directory-listing docker
    </Directory>

    # Regras do .htaccess convertidas para configuração do Apache
    # Bloquear arquivos que começam com ponto (equivalente ao FilesMatch do .htaccess)
    <FilesMatch "^\.">
        Require all denied
    </FilesMatch>

    # Ignorar arquivos específicos (equivalente ao IndexIgnore do .htaccess)
    <FilesMatch "\.(stub\.php|composer\.(json|lock)|php(cs|unit|stan)\.xml|grumphp\.yml|phpstan\.|doctum\.php|md|sh|bat|mmd|lock\.json)$">
        Require all denied
    </FilesMatch>

    # Negar acesso apenas a docker-compose.yml
    <FilesMatch "^(docker-compose\.yml)$">
        Require all denied
    </FilesMatch>

    # Reescrever requisições de favicon para evitar erro 403
    <IfModule mod_rewrite.c>
        RewriteEngine On
        RewriteRule ^favicon\.ico$ - [L,R=204]
    </IfModule>

    # Negar acesso a diretórios específicos
    <Directory "/var/www/html/trash">
        Require all denied
    </Directory>
    <Directory "/var/www/html/vendor">
        Require all denied
    </Directory>
    <Directory "/var/www/html/assets">
        Require all denied
    </Directory>
    <Directory "/var/www/html/cache">
        Require all denied
    </Directory>
    <Directory "/var/www/html/resources">
        Require all denied
    </Directory>
    <Directory "/var/www/html/scripts">
        Require all denied
    </Directory>
    <Directory "/var/www/html/tests">
        Require all denied
    </Directory>
    <Directory "/var/www/html/src">
        Require all denied
    </Directory>
    <Directory "/var/www/html/bin">
        Require all denied
    </Directory>
    # Permitir acesso ao tema apache-directory-listing (antes do bloqueio geral do docker)
    <Directory "/var/www/html/docker/assets/apache-directory-listing">
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>
    <Directory "/var/www/html/docker">
        Require all denied
    </Directory>
    <Directory "/var/www/html/adminer">
        Require all denied
    </Directory>
    <Directory "/var/www/html/patches">
        Require all denied
    </Directory>
    <Directory "/var/www/html/.devcontainer">
        Require all denied
    </Directory>
    <Directory "/var/www/html/.stub">
        Require all denied
    </Directory>

    # Configurar loglevel para não mostrar erros esperados de autorização
    # authz_core:crit suprime os erros AH01630 (client denied by server configuration)
    LogLevel warn authz_core:crit

    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined
</VirtualHost>
