# Configuração Nginx Unificada SSL - Múltiplas versões PHP
# Cada bloco server escuta em uma porta SSL diferente e roteia para o PHP-FPM correspondente
#
# Este arquivo suporta dois modos de operação:
# 1. Modo Genérico: Quando PHP_SERVICE está definido, o bloco na porta 443 usa a variável ${PHP_SERVICE}
# 2. Modo Unificado: Quando PHP_SERVICE não está definido, todos os blocos são usados com serviços hardcoded

# ============================================================================
# Modo Genérico - HTTPS (porta 443) - Usa variável ${PHP_SERVICE}
# Este bloco é processado pelo docker-entrypoint.sh quando PHP_SERVICE está definido
# ============================================================================
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;
    server_name localhost;
    root /var/www/html;
    index index.php index.html index.htm;

    access_log /var/log/nginx/access-ssl.log;
    error_log /var/log/nginx/error-ssl.log;

    ssl_certificate /etc/nginx/ssl/nginx-selfsigned.crt;
    ssl_certificate_key /etc/nginx/ssl/nginx-selfsigned.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    ssl_session_timeout 10m;

    client_max_body_size 100M;
    fastcgi_read_timeout 300;
    fastcgi_send_timeout 300;

    location ^~ /nginx-directory-listing/ {
        alias /var/www/html/docker/assets/nginx-directory-listing/;
        access_log off;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Habilitar listagem de diretórios quando não houver arquivo index
    location = / {
        # Se houver index.php, redirecionar para ele
        if (-f $document_root/index.php) {
            rewrite ^ /index.php last;
        }
        # Caso contrário, usar fancyindex com tema personalizado
        fancyindex on;
        fancyindex_exact_size off;
        fancyindex_localtime on;
        fancyindex_name_length 255;
        fancyindex_header "/docker/assets/nginx-directory-listing/header.html";
        fancyindex_footer "/docker/assets/nginx-directory-listing/footer.html";
        fancyindex_ignore "composer.json" "composer.lock" "phpcs.xml" "phpunit.xml" "phpmd.xml" "phpstan.neon" "grumphp.yml" "doctum.php" "docker-compose.yml" "favicon.ico" "trash" "vendor" "assets" "cache" "resources" "scripts" "tests" "src" "bin" "docker" "adminer" "patches" ".devcontainer" ".stub" ".git" ".env" ".htaccess" "\.md$" "class-diagram.mmd" "flowchart.mmd" "setup.sh" "setup.bat" "setupAll.sh" "setupAll.bat" "nginx-directory-listing";
    }

    location = /index.php {
        fastcgi_pass ${PHP_SERVICE}:9000;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root/index.php;
        fastcgi_param PATH_INFO "";
        fastcgi_param REQUEST_URI /;
    }

    # Negar acesso a arquivos .md (markdown) - DEVE estar antes de location /
    # Usando ~* para case-insensitive matching
    location ~* \.md$ {
        deny all;
        return 403;
        access_log off;
        log_not_found off;
    }
    
    location / {
        # Tentar servir arquivo solicitado, depois diretório, depois index.php
        # Se não encontrar arquivo index, listar conteúdo do diretório
        try_files $uri $uri/ $uri/index.php @autoindex;
        fancyindex on;
        fancyindex_exact_size off;
        fancyindex_localtime on;
        fancyindex_name_length 255;
        fancyindex_header "/docker/assets/nginx-directory-listing/header.html";
        fancyindex_footer "/docker/assets/nginx-directory-listing/footer.html";
        fancyindex_ignore "composer.json" "composer.lock" "phpcs.xml" "phpunit.xml" "phpmd.xml" "phpstan.neon" "grumphp.yml" "doctum.php" "docker-compose.yml" "favicon.ico" "trash" "vendor" "assets" "cache" "resources" "scripts" "tests" "src" "bin" "docker" "adminer" "patches" ".devcontainer" ".stub" ".git" ".env" ".htaccess" "\.md$" "class-diagram.mmd" "flowchart.mmd" "setup.sh" "setup.bat" "setupAll.sh" "setupAll.bat" "nginx-directory-listing";
    }
    
    location @autoindex {
        root /var/www/html;
        fancyindex on;
        fancyindex_exact_size off;
        fancyindex_localtime on;
        fancyindex_name_length 255;
        fancyindex_header "/docker/assets/nginx-directory-listing/header.html";
        fancyindex_footer "/docker/assets/nginx-directory-listing/footer.html";
        fancyindex_ignore "composer.json" "composer.lock" "phpcs.xml" "phpunit.xml" "phpmd.xml" "phpstan.neon" "grumphp.yml" "doctum.php" "docker-compose.yml" "favicon.ico" "trash" "vendor" "assets" "cache" "resources" "scripts" "tests" "src" "bin" "docker" "adminer" "patches" ".devcontainer" ".stub" ".git" ".env" ".htaccess" "\.md$" "class-diagram.mmd" "flowchart.mmd" "setup.sh" "setup.bat" "setupAll.sh" "setupAll.bat" "nginx-directory-listing";
        try_files $uri $uri/ =404;
    }

    location ~ \.php$ {
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass ${PHP_SERVICE}:9000;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME "$document_root$fastcgi_script_name";
        fastcgi_param PATH_INFO "$fastcgi_path_info";
        fastcgi_param HTTPS "on";
        fastcgi_param SSL_PROTOCOL "$ssl_protocol";
        fastcgi_param SSL_CIPHER "$ssl_cipher";
        fastcgi_param SSL_SESSION_ID "$ssl_session_id";
        fastcgi_param SSL_CLIENT_VERIFY "$ssl_client_verify";
    }

    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # Negar acesso a arquivos ocultos
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
}

# ============================================================================
# Modo Unificado - Múltiplas versões PHP
# Os blocos abaixo são usados quando PHP_SERVICE não está definido (nginx-unified)
# ============================================================================

# ============================================================================
# PHP 8.0 - HTTPS (porta 8043)
# ============================================================================
server {
    listen 8043 ssl;
    listen [::]:8043 ssl;
    http2 on;
    server_name localhost;
    root /var/www/html;
    index index.php index.html index.htm;

    access_log /var/log/nginx/access-80-ssl.log;
    error_log /var/log/nginx/error-80-ssl.log;

    ssl_certificate /etc/nginx/ssl/nginx-selfsigned.crt;
    ssl_certificate_key /etc/nginx/ssl/nginx-selfsigned.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    ssl_session_timeout 10m;

    client_max_body_size 100M;
    fastcgi_read_timeout 300;
    fastcgi_send_timeout 300;

    # Servir arquivos estáticos do tema nginx-directory-listing
    location ^~ /nginx-directory-listing/ {
        alias /var/www/html/docker/assets/nginx-directory-listing/;
        access_log off;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # Habilitar listagem de diretórios quando não houver arquivo index
    location = / {
        # Se houver index.php, redirecionar para ele
        if (-f $document_root/index.php) {
            rewrite ^ /index.php last;
        }
        # Caso contrário, usar fancyindex com tema personalizado
        fancyindex on;
        fancyindex_exact_size off;
        fancyindex_localtime on;
        fancyindex_name_length 255;
        fancyindex_header "/docker/assets/nginx-directory-listing/header.html";
        fancyindex_footer "/docker/assets/nginx-directory-listing/footer.html";
        fancyindex_ignore "composer.json" "composer.lock" "phpcs.xml" "phpunit.xml" "phpmd.xml" "phpstan.neon" "grumphp.yml" "doctum.php" "docker-compose.yml" "favicon.ico" "trash" "vendor" "assets" "cache" "resources" "scripts" "tests" "src" "bin" "docker" "adminer" "patches" ".devcontainer" ".stub" ".git" ".env" ".htaccess" "\.md$" "class-diagram.mmd" "flowchart.mmd" "setup.sh" "setup.bat" "setupAll.sh" "setupAll.bat" "nginx-directory-listing";
    }

    # Negar acesso a arquivos .md (markdown) - DEVE estar antes de location /
    # Usando ~* para case-insensitive matching
    location ~* \.md$ {
        deny all;
        return 403;
        access_log off;
        log_not_found off;
    }
    
    location / {
        # Tentar servir arquivo solicitado, depois diretório, depois index.php
        # Se não encontrar arquivo index, listar conteúdo do diretório
        try_files $uri $uri/ $uri/index.php @autoindex;
        fancyindex on;
        fancyindex_exact_size off;
        fancyindex_localtime on;
        fancyindex_name_length 255;
        fancyindex_header "/docker/assets/nginx-directory-listing/header.html";
        fancyindex_footer "/docker/assets/nginx-directory-listing/footer.html";
        fancyindex_ignore "composer.json" "composer.lock" "phpcs.xml" "phpunit.xml" "phpmd.xml" "phpstan.neon" "grumphp.yml" "doctum.php" "docker-compose.yml" "favicon.ico" "trash" "vendor" "assets" "cache" "resources" "scripts" "tests" "src" "bin" "docker" "adminer" "patches" ".devcontainer" ".stub" ".git" ".env" ".htaccess" "\.md$" "class-diagram.mmd" "flowchart.mmd" "setup.sh" "setup.bat" "setupAll.sh" "setupAll.bat" "nginx-directory-listing";
    }
    
    location @autoindex {
        root /var/www/html;
        fancyindex on;
        fancyindex_exact_size off;
        fancyindex_localtime on;
        fancyindex_name_length 255;
        fancyindex_header "/docker/assets/nginx-directory-listing/header.html";
        fancyindex_footer "/docker/assets/nginx-directory-listing/footer.html";
        fancyindex_ignore "composer.json" "composer.lock" "phpcs.xml" "phpunit.xml" "phpmd.xml" "phpstan.neon" "grumphp.yml" "doctum.php" "docker-compose.yml" "favicon.ico" "trash" "vendor" "assets" "cache" "resources" "scripts" "tests" "src" "bin" "docker" "adminer" "patches" ".devcontainer" ".stub" ".git" ".env" ".htaccess" "\.md$" "class-diagram.mmd" "flowchart.mmd" "setup.sh" "setup.bat" "setupAll.sh" "setupAll.bat" "nginx-directory-listing";
        try_files $uri $uri/ =404;
    }

    location ~ \.php$ {
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass php-8.0-fpm:9000;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME "$document_root$fastcgi_script_name";
        fastcgi_param PATH_INFO "$fastcgi_path_info";
        fastcgi_param HTTPS "on";
        fastcgi_param SSL_PROTOCOL "$ssl_protocol";
        fastcgi_param SSL_CIPHER "$ssl_cipher";
        fastcgi_param SSL_SESSION_ID "$ssl_session_id";
        fastcgi_param SSL_CLIENT_VERIFY "$ssl_client_verify";
    }

    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # Negar acesso a arquivos ocultos
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
}

# ============================================================================
# PHP 8.1 - HTTPS (porta 8143)
# ============================================================================
server {
    listen 8143 ssl;
    listen [::]:8143 ssl;
    http2 on;
    server_name localhost;
    root /var/www/html;
    index index.php index.html index.htm;

    access_log /var/log/nginx/access-81-ssl.log;
    error_log /var/log/nginx/error-81-ssl.log;

    ssl_certificate /etc/nginx/ssl/nginx-selfsigned.crt;
    ssl_certificate_key /etc/nginx/ssl/nginx-selfsigned.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    ssl_session_timeout 10m;

    client_max_body_size 100M;
    fastcgi_read_timeout 300;
    fastcgi_send_timeout 300;

    # Servir arquivos estáticos do tema nginx-directory-listing
    location ^~ /nginx-directory-listing/ {
        alias /var/www/html/docker/assets/nginx-directory-listing/;
        access_log off;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # Habilitar listagem de diretórios quando não houver arquivo index
    location = / {
        # Se houver index.php, redirecionar para ele
        if (-f $document_root/index.php) {
            rewrite ^ /index.php last;
        }
        # Caso contrário, usar fancyindex com tema personalizado
        fancyindex on;
        fancyindex_exact_size off;
        fancyindex_localtime on;
        fancyindex_name_length 255;
        fancyindex_header "/docker/assets/nginx-directory-listing/header.html";
        fancyindex_footer "/docker/assets/nginx-directory-listing/footer.html";
        fancyindex_ignore "composer.json" "composer.lock" "phpcs.xml" "phpunit.xml" "phpmd.xml" "phpstan.neon" "grumphp.yml" "doctum.php" "docker-compose.yml" "favicon.ico" "trash" "vendor" "assets" "cache" "resources" "scripts" "tests" "src" "bin" "docker" "adminer" "patches" ".devcontainer" ".stub" ".git" ".env" ".htaccess" "\.md$" "class-diagram.mmd" "flowchart.mmd" "setup.sh" "setup.bat" "setupAll.sh" "setupAll.bat" "nginx-directory-listing";
    }

    # Negar acesso a arquivos .md (markdown) - DEVE estar antes de location /
    # Usando ~* para case-insensitive matching
    location ~* \.md$ {
        deny all;
        return 403;
        access_log off;
        log_not_found off;
    }
    
    location / {
        # Tentar servir arquivo solicitado, depois diretório, depois index.php
        # Se não encontrar arquivo index, listar conteúdo do diretório
        try_files $uri $uri/ $uri/index.php @autoindex;
        fancyindex on;
        fancyindex_exact_size off;
        fancyindex_localtime on;
        fancyindex_name_length 255;
        fancyindex_header "/docker/assets/nginx-directory-listing/header.html";
        fancyindex_footer "/docker/assets/nginx-directory-listing/footer.html";
        fancyindex_ignore "composer.json" "composer.lock" "phpcs.xml" "phpunit.xml" "phpmd.xml" "phpstan.neon" "grumphp.yml" "doctum.php" "docker-compose.yml" "favicon.ico" "trash" "vendor" "assets" "cache" "resources" "scripts" "tests" "src" "bin" "docker" "adminer" "patches" ".devcontainer" ".stub" ".git" ".env" ".htaccess" "\.md$" "class-diagram.mmd" "flowchart.mmd" "setup.sh" "setup.bat" "setupAll.sh" "setupAll.bat" "nginx-directory-listing";
    }
    
    location @autoindex {
        root /var/www/html;
        fancyindex on;
        fancyindex_exact_size off;
        fancyindex_localtime on;
        fancyindex_name_length 255;
        fancyindex_header "/docker/assets/nginx-directory-listing/header.html";
        fancyindex_footer "/docker/assets/nginx-directory-listing/footer.html";
        fancyindex_ignore "composer.json" "composer.lock" "phpcs.xml" "phpunit.xml" "phpmd.xml" "phpstan.neon" "grumphp.yml" "doctum.php" "docker-compose.yml" "favicon.ico" "trash" "vendor" "assets" "cache" "resources" "scripts" "tests" "src" "bin" "docker" "adminer" "patches" ".devcontainer" ".stub" ".git" ".env" ".htaccess" "\.md$" "class-diagram.mmd" "flowchart.mmd" "setup.sh" "setup.bat" "setupAll.sh" "setupAll.bat" "nginx-directory-listing";
        try_files $uri $uri/ =404;
    }

    location ~ \.php$ {
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass php-8.1-fpm:9000;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME "$document_root$fastcgi_script_name";
        fastcgi_param PATH_INFO "$fastcgi_path_info";
        fastcgi_param HTTPS "on";
        fastcgi_param SSL_PROTOCOL "$ssl_protocol";
        fastcgi_param SSL_CIPHER "$ssl_cipher";
        fastcgi_param SSL_SESSION_ID "$ssl_session_id";
        fastcgi_param SSL_CLIENT_VERIFY "$ssl_client_verify";
    }

    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # Negar acesso a arquivos ocultos
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
}

# ============================================================================
# PHP 8.2 - HTTPS (porta 8243)
# ============================================================================
server {
    listen 8243 ssl;
    listen [::]:8243 ssl;
    http2 on;
    server_name localhost;
    root /var/www/html;
    index index.php index.html index.htm;

    access_log /var/log/nginx/access-82-ssl.log;
    error_log /var/log/nginx/error-82-ssl.log;

    ssl_certificate /etc/nginx/ssl/nginx-selfsigned.crt;
    ssl_certificate_key /etc/nginx/ssl/nginx-selfsigned.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    ssl_session_timeout 10m;

    client_max_body_size 100M;
    fastcgi_read_timeout 300;
    fastcgi_send_timeout 300;

    # Servir arquivos estáticos do tema nginx-directory-listing
    location ^~ /nginx-directory-listing/ {
        alias /var/www/html/docker/assets/nginx-directory-listing/;
        access_log off;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # Habilitar listagem de diretórios quando não houver arquivo index
    location = / {
        # Se houver index.php, redirecionar para ele
        if (-f $document_root/index.php) {
            rewrite ^ /index.php last;
        }
        # Caso contrário, usar fancyindex com tema personalizado
        fancyindex on;
        fancyindex_exact_size off;
        fancyindex_localtime on;
        fancyindex_name_length 255;
        fancyindex_header "/docker/assets/nginx-directory-listing/header.html";
        fancyindex_footer "/docker/assets/nginx-directory-listing/footer.html";
        fancyindex_ignore "composer.json" "composer.lock" "phpcs.xml" "phpunit.xml" "phpmd.xml" "phpstan.neon" "grumphp.yml" "doctum.php" "docker-compose.yml" "favicon.ico" "trash" "vendor" "assets" "cache" "resources" "scripts" "tests" "src" "bin" "docker" "adminer" "patches" ".devcontainer" ".stub" ".git" ".env" ".htaccess" "\.md$" "class-diagram.mmd" "flowchart.mmd" "setup.sh" "setup.bat" "setupAll.sh" "setupAll.bat" "nginx-directory-listing";
    }

    # Negar acesso a arquivos .md (markdown) - DEVE estar antes de location /
    # Usando ~* para case-insensitive matching
    location ~* \.md$ {
        deny all;
        return 403;
        access_log off;
        log_not_found off;
    }
    
    location / {
        # Tentar servir arquivo solicitado, depois diretório, depois index.php
        # Se não encontrar arquivo index, listar conteúdo do diretório
        try_files $uri $uri/ $uri/index.php @autoindex;
        fancyindex on;
        fancyindex_exact_size off;
        fancyindex_localtime on;
        fancyindex_name_length 255;
        fancyindex_header "/docker/assets/nginx-directory-listing/header.html";
        fancyindex_footer "/docker/assets/nginx-directory-listing/footer.html";
        fancyindex_ignore "composer.json" "composer.lock" "phpcs.xml" "phpunit.xml" "phpmd.xml" "phpstan.neon" "grumphp.yml" "doctum.php" "docker-compose.yml" "favicon.ico" "trash" "vendor" "assets" "cache" "resources" "scripts" "tests" "src" "bin" "docker" "adminer" "patches" ".devcontainer" ".stub" ".git" ".env" ".htaccess" "\.md$" "class-diagram.mmd" "flowchart.mmd" "setup.sh" "setup.bat" "setupAll.sh" "setupAll.bat" "nginx-directory-listing";
    }
    
    location @autoindex {
        root /var/www/html;
        fancyindex on;
        fancyindex_exact_size off;
        fancyindex_localtime on;
        fancyindex_name_length 255;
        fancyindex_header "/docker/assets/nginx-directory-listing/header.html";
        fancyindex_footer "/docker/assets/nginx-directory-listing/footer.html";
        fancyindex_ignore "composer.json" "composer.lock" "phpcs.xml" "phpunit.xml" "phpmd.xml" "phpstan.neon" "grumphp.yml" "doctum.php" "docker-compose.yml" "favicon.ico" "trash" "vendor" "assets" "cache" "resources" "scripts" "tests" "src" "bin" "docker" "adminer" "patches" ".devcontainer" ".stub" ".git" ".env" ".htaccess" "\.md$" "class-diagram.mmd" "flowchart.mmd" "setup.sh" "setup.bat" "setupAll.sh" "setupAll.bat" "nginx-directory-listing";
        try_files $uri $uri/ =404;
    }

    location ~ \.php$ {
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass php-8.2-fpm:9000;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME "$document_root$fastcgi_script_name";
        fastcgi_param PATH_INFO "$fastcgi_path_info";
        fastcgi_param HTTPS "on";
        fastcgi_param SSL_PROTOCOL "$ssl_protocol";
        fastcgi_param SSL_CIPHER "$ssl_cipher";
        fastcgi_param SSL_SESSION_ID "$ssl_session_id";
        fastcgi_param SSL_CLIENT_VERIFY "$ssl_client_verify";
    }

    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # Negar acesso a arquivos ocultos
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
}

# ============================================================================
# PHP 8.3 - HTTPS (porta 8343)
# ============================================================================
server {
    listen 8343 ssl;
    listen [::]:8343 ssl;
    http2 on;
    server_name localhost;
    root /var/www/html;
    index index.php index.html index.htm;

    access_log /var/log/nginx/access-83-ssl.log;
    error_log /var/log/nginx/error-83-ssl.log;

    ssl_certificate /etc/nginx/ssl/nginx-selfsigned.crt;
    ssl_certificate_key /etc/nginx/ssl/nginx-selfsigned.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    ssl_session_timeout 10m;

    client_max_body_size 100M;
    fastcgi_read_timeout 300;
    fastcgi_send_timeout 300;

    # Servir arquivos estáticos do tema nginx-directory-listing
    location ^~ /nginx-directory-listing/ {
        alias /var/www/html/docker/assets/nginx-directory-listing/;
        access_log off;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # Habilitar listagem de diretórios quando não houver arquivo index
    location = / {
        # Se houver index.php, redirecionar para ele
        if (-f $document_root/index.php) {
            rewrite ^ /index.php last;
        }
        # Caso contrário, usar fancyindex com tema personalizado
        fancyindex on;
        fancyindex_exact_size off;
        fancyindex_localtime on;
        fancyindex_name_length 255;
        fancyindex_header "/docker/assets/nginx-directory-listing/header.html";
        fancyindex_footer "/docker/assets/nginx-directory-listing/footer.html";
        fancyindex_ignore "composer.json" "composer.lock" "phpcs.xml" "phpunit.xml" "phpmd.xml" "phpstan.neon" "grumphp.yml" "doctum.php" "docker-compose.yml" "favicon.ico" "trash" "vendor" "assets" "cache" "resources" "scripts" "tests" "src" "bin" "docker" "adminer" "patches" ".devcontainer" ".stub" ".git" ".env" ".htaccess" "\.md$" "class-diagram.mmd" "flowchart.mmd" "setup.sh" "setup.bat" "setupAll.sh" "setupAll.bat" "nginx-directory-listing";
    }

    # Negar acesso a arquivos .md (markdown) - DEVE estar antes de location /
    # Usando ~* para case-insensitive matching
    location ~* \.md$ {
        deny all;
        return 403;
        access_log off;
        log_not_found off;
    }
    
    location / {
        # Tentar servir arquivo solicitado, depois diretório, depois index.php
        # Se não encontrar arquivo index, listar conteúdo do diretório
        try_files $uri $uri/ $uri/index.php @autoindex;
        fancyindex on;
        fancyindex_exact_size off;
        fancyindex_localtime on;
        fancyindex_name_length 255;
        fancyindex_header "/docker/assets/nginx-directory-listing/header.html";
        fancyindex_footer "/docker/assets/nginx-directory-listing/footer.html";
        fancyindex_ignore "composer.json" "composer.lock" "phpcs.xml" "phpunit.xml" "phpmd.xml" "phpstan.neon" "grumphp.yml" "doctum.php" "docker-compose.yml" "favicon.ico" "trash" "vendor" "assets" "cache" "resources" "scripts" "tests" "src" "bin" "docker" "adminer" "patches" ".devcontainer" ".stub" ".git" ".env" ".htaccess" "\.md$" "class-diagram.mmd" "flowchart.mmd" "setup.sh" "setup.bat" "setupAll.sh" "setupAll.bat" "nginx-directory-listing";
    }
    
    location @autoindex {
        root /var/www/html;
        fancyindex on;
        fancyindex_exact_size off;
        fancyindex_localtime on;
        fancyindex_name_length 255;
        fancyindex_header "/docker/assets/nginx-directory-listing/header.html";
        fancyindex_footer "/docker/assets/nginx-directory-listing/footer.html";
        fancyindex_ignore "composer.json" "composer.lock" "phpcs.xml" "phpunit.xml" "phpmd.xml" "phpstan.neon" "grumphp.yml" "doctum.php" "docker-compose.yml" "favicon.ico" "trash" "vendor" "assets" "cache" "resources" "scripts" "tests" "src" "bin" "docker" "adminer" "patches" ".devcontainer" ".stub" ".git" ".env" ".htaccess" "\.md$" "class-diagram.mmd" "flowchart.mmd" "setup.sh" "setup.bat" "setupAll.sh" "setupAll.bat" "nginx-directory-listing";
        try_files $uri $uri/ =404;
    }

    location ~ \.php$ {
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass php-8.3-fpm:9000;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME "$document_root$fastcgi_script_name";
        fastcgi_param PATH_INFO "$fastcgi_path_info";
        fastcgi_param HTTPS "on";
        fastcgi_param SSL_PROTOCOL "$ssl_protocol";
        fastcgi_param SSL_CIPHER "$ssl_cipher";
        fastcgi_param SSL_SESSION_ID "$ssl_session_id";
        fastcgi_param SSL_CLIENT_VERIFY "$ssl_client_verify";
    }

    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # Negar acesso a arquivos ocultos
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
}

# ============================================================================
# PHP 8.4 - HTTPS (porta 8443)
# ============================================================================
server {
    listen 8443 ssl;
    listen [::]:8443 ssl;
    http2 on;
    server_name localhost;
    root /var/www/html;
    index index.php index.html index.htm;

    access_log /var/log/nginx/access-84-ssl.log;
    error_log /var/log/nginx/error-84-ssl.log;

    ssl_certificate /etc/nginx/ssl/nginx-selfsigned.crt;
    ssl_certificate_key /etc/nginx/ssl/nginx-selfsigned.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    ssl_session_timeout 10m;

    client_max_body_size 100M;
    fastcgi_read_timeout 300;
    fastcgi_send_timeout 300;

    # Servir arquivos estáticos do tema nginx-directory-listing
    location ^~ /nginx-directory-listing/ {
        alias /var/www/html/docker/assets/nginx-directory-listing/;
        access_log off;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # Habilitar listagem de diretórios quando não houver arquivo index
    location = / {
        # Se houver index.php, redirecionar para ele
        if (-f $document_root/index.php) {
            rewrite ^ /index.php last;
        }
        # Caso contrário, usar fancyindex com tema personalizado
        fancyindex on;
        fancyindex_exact_size off;
        fancyindex_localtime on;
        fancyindex_name_length 255;
        fancyindex_header "/docker/assets/nginx-directory-listing/header.html";
        fancyindex_footer "/docker/assets/nginx-directory-listing/footer.html";
        fancyindex_ignore "composer.json" "composer.lock" "phpcs.xml" "phpunit.xml" "phpmd.xml" "phpstan.neon" "grumphp.yml" "doctum.php" "docker-compose.yml" "favicon.ico" "trash" "vendor" "assets" "cache" "resources" "scripts" "tests" "src" "bin" "docker" "adminer" "patches" ".devcontainer" ".stub" ".git" ".env" ".htaccess" "\.md$" "class-diagram.mmd" "flowchart.mmd" "setup.sh" "setup.bat" "setupAll.sh" "setupAll.bat" "nginx-directory-listing";
    }

    # Negar acesso a arquivos .md (markdown) - DEVE estar antes de location /
    # Usando ~* para case-insensitive matching
    location ~* \.md$ {
        deny all;
        return 403;
        access_log off;
        log_not_found off;
    }
    
    location / {
        # Tentar servir arquivo solicitado, depois diretório, depois index.php
        # Se não encontrar arquivo index, listar conteúdo do diretório
        try_files $uri $uri/ $uri/index.php @autoindex;
        fancyindex on;
        fancyindex_exact_size off;
        fancyindex_localtime on;
        fancyindex_name_length 255;
        fancyindex_header "/docker/assets/nginx-directory-listing/header.html";
        fancyindex_footer "/docker/assets/nginx-directory-listing/footer.html";
        fancyindex_ignore "composer.json" "composer.lock" "phpcs.xml" "phpunit.xml" "phpmd.xml" "phpstan.neon" "grumphp.yml" "doctum.php" "docker-compose.yml" "favicon.ico" "trash" "vendor" "assets" "cache" "resources" "scripts" "tests" "src" "bin" "docker" "adminer" "patches" ".devcontainer" ".stub" ".git" ".env" ".htaccess" "\.md$" "class-diagram.mmd" "flowchart.mmd" "setup.sh" "setup.bat" "setupAll.sh" "setupAll.bat" "nginx-directory-listing";
    }
    
    location @autoindex {
        root /var/www/html;
        fancyindex on;
        fancyindex_exact_size off;
        fancyindex_localtime on;
        fancyindex_name_length 255;
        fancyindex_header "/docker/assets/nginx-directory-listing/header.html";
        fancyindex_footer "/docker/assets/nginx-directory-listing/footer.html";
        fancyindex_ignore "composer.json" "composer.lock" "phpcs.xml" "phpunit.xml" "phpmd.xml" "phpstan.neon" "grumphp.yml" "doctum.php" "docker-compose.yml" "favicon.ico" "trash" "vendor" "assets" "cache" "resources" "scripts" "tests" "src" "bin" "docker" "adminer" "patches" ".devcontainer" ".stub" ".git" ".env" ".htaccess" "\.md$" "class-diagram.mmd" "flowchart.mmd" "setup.sh" "setup.bat" "setupAll.sh" "setupAll.bat" "nginx-directory-listing";
        try_files $uri $uri/ =404;
    }

    location ~ \.php$ {
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass php-8.4-fpm:9000;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME "$document_root$fastcgi_script_name";
        fastcgi_param PATH_INFO "$fastcgi_path_info";
        fastcgi_param HTTPS "on";
        fastcgi_param SSL_PROTOCOL "$ssl_protocol";
        fastcgi_param SSL_CIPHER "$ssl_cipher";
        fastcgi_param SSL_SESSION_ID "$ssl_session_id";
        fastcgi_param SSL_CLIENT_VERIFY "$ssl_client_verify";
    }

    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # Negar acesso a arquivos ocultos
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
}

# ============================================================================
# PHP 8.5 - HTTPS (porta 8543)
# ============================================================================
server {
    listen 8543 ssl;
    listen [::]:8543 ssl;
    http2 on;
    server_name localhost;
    root /var/www/html;
    index index.php index.html index.htm;

    access_log /var/log/nginx/access-85-ssl.log;
    error_log /var/log/nginx/error-85-ssl.log;

    ssl_certificate /etc/nginx/ssl/nginx-selfsigned.crt;
    ssl_certificate_key /etc/nginx/ssl/nginx-selfsigned.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    ssl_session_timeout 10m;

    client_max_body_size 100M;
    fastcgi_read_timeout 300;
    fastcgi_send_timeout 300;

    # Servir arquivos estáticos do tema nginx-directory-listing
    location ^~ /nginx-directory-listing/ {
        alias /var/www/html/docker/assets/nginx-directory-listing/;
        access_log off;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # Habilitar listagem de diretórios quando não houver arquivo index
    location = / {
        # Se houver index.php, redirecionar para ele
        if (-f $document_root/index.php) {
            rewrite ^ /index.php last;
        }
        # Caso contrário, usar fancyindex com tema personalizado
        fancyindex on;
        fancyindex_exact_size off;
        fancyindex_localtime on;
        fancyindex_name_length 255;
        fancyindex_header "/docker/assets/nginx-directory-listing/header.html";
        fancyindex_footer "/docker/assets/nginx-directory-listing/footer.html";
        fancyindex_ignore "composer.json" "composer.lock" "phpcs.xml" "phpunit.xml" "phpmd.xml" "phpstan.neon" "grumphp.yml" "doctum.php" "docker-compose.yml" "favicon.ico" "trash" "vendor" "assets" "cache" "resources" "scripts" "tests" "src" "bin" "docker" "adminer" "patches" ".devcontainer" ".stub" ".git" ".env" ".htaccess" "\.md$" "class-diagram.mmd" "flowchart.mmd" "setup.sh" "setup.bat" "setupAll.sh" "setupAll.bat" "nginx-directory-listing";
    }

    # Negar acesso a arquivos .md (markdown) - DEVE estar antes de location /
    # Usando ~* para case-insensitive matching
    location ~* \.md$ {
        deny all;
        return 403;
        access_log off;
        log_not_found off;
    }
    
    location / {
        # Tentar servir arquivo solicitado, depois diretório, depois index.php
        # Se não encontrar arquivo index, listar conteúdo do diretório
        try_files $uri $uri/ $uri/index.php @autoindex;
        fancyindex on;
        fancyindex_exact_size off;
        fancyindex_localtime on;
        fancyindex_name_length 255;
        fancyindex_header "/docker/assets/nginx-directory-listing/header.html";
        fancyindex_footer "/docker/assets/nginx-directory-listing/footer.html";
        fancyindex_ignore "composer.json" "composer.lock" "phpcs.xml" "phpunit.xml" "phpmd.xml" "phpstan.neon" "grumphp.yml" "doctum.php" "docker-compose.yml" "favicon.ico" "trash" "vendor" "assets" "cache" "resources" "scripts" "tests" "src" "bin" "docker" "adminer" "patches" ".devcontainer" ".stub" ".git" ".env" ".htaccess" "\.md$" "class-diagram.mmd" "flowchart.mmd" "setup.sh" "setup.bat" "setupAll.sh" "setupAll.bat" "nginx-directory-listing";
    }
    
    location @autoindex {
        root /var/www/html;
        fancyindex on;
        fancyindex_exact_size off;
        fancyindex_localtime on;
        fancyindex_name_length 255;
        fancyindex_header "/docker/assets/nginx-directory-listing/header.html";
        fancyindex_footer "/docker/assets/nginx-directory-listing/footer.html";
        fancyindex_ignore "composer.json" "composer.lock" "phpcs.xml" "phpunit.xml" "phpmd.xml" "phpstan.neon" "grumphp.yml" "doctum.php" "docker-compose.yml" "favicon.ico" "trash" "vendor" "assets" "cache" "resources" "scripts" "tests" "src" "bin" "docker" "adminer" "patches" ".devcontainer" ".stub" ".git" ".env" ".htaccess" "\.md$" "class-diagram.mmd" "flowchart.mmd" "setup.sh" "setup.bat" "setupAll.sh" "setupAll.bat" "nginx-directory-listing";
        try_files $uri $uri/ =404;
    }

    location ~ \.php$ {
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass php-8.5-fpm:9000;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME "$document_root$fastcgi_script_name";
        fastcgi_param PATH_INFO "$fastcgi_path_info";
        fastcgi_param HTTPS "on";
        fastcgi_param SSL_PROTOCOL "$ssl_protocol";
        fastcgi_param SSL_CIPHER "$ssl_cipher";
        fastcgi_param SSL_SESSION_ID "$ssl_session_id";
        fastcgi_param SSL_CLIENT_VERIFY "$ssl_client_verify";
    }

    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # Negar acesso a arquivos ocultos
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
}
